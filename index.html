<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whack-a-Mole PWA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- your existing styles stay the same --- */
    </style>
</head>
<body>
    <!-- --- your existing HTML content stays the same --- -->

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, 
            query, orderBy, limit, serverTimestamp, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Your real Firebase config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCfUYc0o9nC9fhTp4w-WQhw7dvqudmhlx8",
            authDomain: "whack-a-mole-49b38.firebaseapp.com",
            projectId: "whack-a-mole-49b38",
            storageBucket: "whack-a-mole-49b38.firebasestorage.app",
            messagingSenderId: "362854772496",
            appId: "1:362854772496:web:5bfa887d324de75abe7f95",
            measurementId: "G-Y90KKRQG4N"
        };

        const appId = "whack-a-mole"; // used for leaderboard collection

        // Initialize Firebase
        let db, auth, userId = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Enable offline persistence
            enableIndexedDbPersistence(db).catch(err => {
                console.warn("Firestore persistence error:", err.code);
            });
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // Game state variables
        let score = 0;
        let timeLeft = 60;
        let timerId;
        let moleTimerId;
        let lastHole;
        let holes = document.querySelectorAll('.hole');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('start-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const leaderboardList = document.getElementById('leaderboard');
        const offlineStatus = document.getElementById('offline-status');
        let isOnline = true;

        // Setup Firebase authentication
        async function setupFirebase() {
            if (!auth) return; // Firebase not loaded
            try {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                console.log("Firebase authenticated:", userId);
                loadLeaderboard();
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }

        // Load leaderboard
        function loadLeaderboard() {
            if (!db) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/leaderboard`), orderBy("score", "desc"), limit(10));
            onSnapshot(q, (querySnapshot) => {
                leaderboardList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const entry = document.createElement('li');
                    entry.textContent = `${data.name}: ${data.score}`;
                    leaderboardList.appendChild(entry);
                });
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
            });
        }

        // Save score
        async function saveScore(finalScore) {
            if (!isOnline || !db) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
                const docSnap = await getDoc(docRef);

                let playerName = "Player";
                if (docSnap.exists()) {
                    playerName = docSnap.data().name || "Player";
                } else {
                    const newName = prompt("What's your name for the leaderboard?") || "Player";
                    playerName = newName;
                }

                await setDoc(docRef, {
                    name: playerName,
                    score: finalScore,
                    timestamp: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error saving score:", error);
            }
        }

        // Game functions
        function randomHole(holes) {
            const index = Math.floor(Math.random() * holes.length);
            const hole = holes[index];
            if (hole === lastHole) return randomHole(holes);
            lastHole = hole;
            return hole;
        }

        function popUp() {
            const time = Math.random() * 1000 + 500;
            const hole = randomHole(holes);
            hole.classList.add('up');
            moleTimerId = setTimeout(() => {
                hole.classList.remove('up');
                if (timeLeft > 0) popUp();
            }, time);
        }

        function startGame() {
            score = 0;
            timeLeft = 60;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;
            startButton.disabled = true;

            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            popUp();
        }

        function endGame() {
            clearInterval(timerId);
            clearTimeout(moleTimerId);
            holes.forEach(hole => hole.classList.remove('up'));
            startButton.disabled = false;
            finalScoreDisplay.textContent = score;
            gameOverModal.classList.add('show');
            if (isOnline) saveScore(score);
        }

        function whack(e) {
            if (!e.isTrusted) return;
            if (this.classList.contains('up')) {
                score++;
                scoreDisplay.textContent = score;
                this.classList.remove('up');
            }
        }

        holes.forEach(hole => hole.addEventListener('click', whack));
        startButton.addEventListener('click', startGame);

        // Offline/online handling
        function handleNetworkStatus() {
            isOnline = navigator.onLine;
            offlineStatus.classList.toggle('show', !isOnline);
            if (isOnline && !userId) setupFirebase();
        }

        window.addEventListener('online', handleNetworkStatus);
        window.addEventListener('offline', handleNetworkStatus);
        handleNetworkStatus();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered:', reg.scope))
            .catch(err => console.error('SW registration failed:', err));
        }

        setupFirebase();
    </script>
</body>
</html>